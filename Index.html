<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phone Directory — Offline + Sync</title>
  <style>
    :root{--bg:#070707;--card:#0f0f10;--muted:#9aa0a6}
    *{box-sizing:border-box;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    html,body{height:100%;background:var(--bg);margin:0;color:#fff}
    .wrap{max-width:980px;margin:36px auto;padding:0 20px}
    .card{position:relative;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:28px 32px;margin:36px 0;box-shadow:0 10px 30px rgba(0,0,0,0.6);overflow:visible}
    .rgb-bar{position:absolute;left:12px;right:12px;height:10px;border-radius:8px;z-index:0;top:-18px;background:linear-gradient(90deg,#ff4d4d,#7fff00,#00e5ff,#ff4d4d);background-size:400% 100%;animation:slide 8s linear infinite}
    .rgb-bar.bottom{top:auto;bottom:-18px;transform:rotate(180deg)}
    @keyframes slide{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    h1.title{text-align:center;font-size:26px;margin:6px 0 14px 0;z-index:1;position:relative}

    form{display:grid;grid-template-columns:1fr;gap:12px;z-index:1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=tel]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    select{padding:10px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;min-width:120px}
    .btn{padding:12px;border-radius:10px;border:0;background:linear-gradient(90deg,#ff4d4d,#00e5ff);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .edit-small{padding:6px 10px;border-radius:8px;border:0;background:transparent;color:#00e5ff;cursor:pointer;font-weight:600;font-size:12px}
    .edit-small.danger{color:#ff6b6b}
    .call-icon{margin-left:8px;text-decoration:none;font-size:18px;cursor:pointer}
    .call-icon:hover{opacity:0.8}
    .small-muted{color:var(--muted);font-size:13px;margin-top:8px}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    th{color:var(--muted)}
    .suggestions{position:relative}
    .suggestions-list{position:absolute;left:0;right:0;top:46px;background:var(--card);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.6);max-height:220px;overflow:auto;z-index:50;border:1px solid rgba(255,255,255,0.04)}
    .suggestion-item{padding:10px 12px;cursor:pointer;font-size:14px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .suggestion-item:last-child{border-bottom:0}
    .suggestion-item:hover{background:rgba(255,255,255,0.05)}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="rgb-bar"></div>
      <h1 class="title">Phone Directory — Offline + Sync</h1>

      <form id="entryForm" autocomplete="off">
        <div>
          <label>Name</label>
          <input id="name" type="text" placeholder="Full name">
        </div>

        <div>
          <label>Mobile Number</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="countryCode"></select>
            <input id="mobile" type="tel" placeholder="98765 43210" style="flex:1">
          </div>
        </div>

        <div>
          <label>Profession</label>
          <input id="profession" type="text" placeholder="e.g. Trader">
        </div>

        <div>
          <label>From</label>
          <input id="from" type="text" placeholder="City / Organization">
        </div>

        <div>
          <label>Notes</label>
          <input id="notes" type="text" placeholder="Remarks / extra info">
        </div>

        <button id="saveBtn" class="btn" type="submit">Save</button>

        <div style="display:flex;gap:12px;align-items:flex-start">
          <div class="suggestions" style="flex:1">
            <input id="q" type="text" placeholder="Search name, mobile, profession, from or notes" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff">
            <div id="suggestionsList" class="suggestions-list" style="display:none"></div>
          </div>
          <button id="searchBtn" type="button" class="btn secondary">Search</button>
        </div>
      </form>

      <div id="status" class="small-muted">Status: Initializing…</div>

      <table>
        <thead>
          <tr>
            <th>Name</th><th>Mobile</th><th>Profession</th><th>From</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="small-muted">No records</td></tr>
        </tbody>
      </table>

      <div class="rgb-bar bottom"></div>
    </section>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw4uD-SqrSUTnCVIYjjCffk03RfrIo-HA--6u2tkYcu43y2dnr0cY2xB3QpsDanZkSx/exec";

const STORAGE_KEY = "phone_directory_v2";
const QUEUE_KEY   = "phone_sync_queue_v2";

let phonebook = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
let syncQueue = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");

const nameEl = document.getElementById("name");
const mobileEl = document.getElementById("mobile");
const ccEl = document.getElementById("countryCode");
const professionEl = document.getElementById("profession");
const fromEl = document.getElementById("from");
const notesEl = document.getElementById("notes");
const qEl = document.getElementById("q");
const tbody = document.getElementById("tbody");
const statusEl = document.getElementById("status");
let editingOriginalMobile = null;

const COUNTRY_CODES = [
  { code: "+91", label: "India (+91)" },
  { code: "+1",  label: "USA (+1)" },
  { code: "+44", label: "UK (+44)" },
  { code: "+971",label: "UAE (+971)" },
  { code: "+92", label: "Pakistan (+92)" },
  { code: "+977",label: "Nepal (+977)" }
];

function initCountryList(){
  COUNTRY_CODES.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.code;
    opt.textContent = c.label;
    ccEl.appendChild(opt);
  });
  ccEl.value = "+91";
}

function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(phonebook)); }
function saveQueue(){ localStorage.setItem(QUEUE_KEY, JSON.stringify(syncQueue)); }
function updateStatus(msg){ statusEl.textContent = "Status: " + msg; }

function fullNumber(obj){
  const cc  = obj.countryCode || "";
  const num = obj.mobile || "";
  if(!cc) return num || "";
  if(!num) return cc;
  return cc + " " + num;
}

function apiPost(payload){
  const body = new URLSearchParams();
  Object.keys(payload).forEach(k=> body.append(k, payload[k]));
  return fetch(SCRIPT_URL, {method:"POST", body})
    .then(r=>r.json())
    .catch(()=>({status:"error"}));
}
function apiGet(params){
  const url = new URL(SCRIPT_URL);
  Object.keys(params).forEach(k=>url.searchParams.set(k, params[k]));
  return fetch(url).then(r=>r.json()).catch(()=>({status:"error"}));
}

function render(list){
  tbody.innerHTML = "";
  if(!list.length){
    tbody.innerHTML = `<tr><td colspan="6" class="small-muted">No records</td></tr>`;
    return;
  }
  list.forEach(item=>{
    const fn = fullNumber(item).trim();
    const dial = fn.replace(/\s+/g,"");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${fn || ""} ${dial ? `<a href="tel:${dial}" class="call-icon">&#128222;</a>` : ""}</td>
      <td>${item.profession||""}</td>
      <td>${item.from||""}</td>
      <td>${item.notes||""}</td>
      <td>
        <button class="edit-small" data-edit>Edit</button>
        <button class="edit-small danger" data-del>Delete</button>
      </td>
    `;
    tr.querySelector("[data-edit]").onclick = ()=>loadIntoForm(item);
    tr.querySelector("[data-del]").onclick  = ()=>deleteItem(item);
    tbody.appendChild(tr);
  });
}

function loadIntoForm(item){
  nameEl.value = item.name;
  mobileEl.value = item.mobile;
  professionEl.value = item.profession||"";
  fromEl.value = item.from||"";
  notesEl.value = item.notes||"";
  ccEl.value = item.countryCode || "+91";

  editingOriginalMobile = fullNumber(item).trim() || item.mobile;
  document.getElementById("saveBtn").textContent = "Update";
  updateStatus("Editing contact");
}

function deleteItem(item){
  const original = fullNumber(item).trim() || item.mobile;
  if(!original) return;
  if(!confirm("Delete this contact?")) return;

  phonebook = phonebook.filter(it => (fullNumber(it).trim() || it.mobile) !== original);
  saveLocal();
  render(phonebook);

  syncQueue.push({op:"delete", original});
  saveQueue();
  processQueue();
  updateStatus("Deleted locally");
}

document.getElementById("entryForm").onsubmit = async(e)=>{
  e.preventDefault();
  const data = {
    name: nameEl.value.trim(),
    mobile: mobileEl.value.trim(),
    countryCode: ccEl.value.trim(),
    profession: professionEl.value.trim(),
    from: fromEl.value.trim(),
    notes: notesEl.value.trim()
  };
  if(!data.name || !data.mobile){
    alert("Name + number required"); return;
  }

  if(editingOriginalMobile){
    const idx = phonebook.findIndex(x => (fullNumber(x).trim() || x.mobile) === editingOriginalMobile);
    if(idx >= 0) phonebook[idx] = {...data};
    saveLocal();
    render(phonebook);

    syncQueue.push({op:"update", original:editingOriginalMobile, payload:data});
    saveQueue();
    editingOriginalMobile = null;
    document.getElementById("saveBtn").textContent = "Save";
    updateStatus("Updated locally");
  }else{
    phonebook.unshift(data);
    saveLocal();
    render(phonebook);
    syncQueue.push({op:"add", payload:data});
    saveQueue();
    updateStatus("Saved locally");
  }
  processQueue();

  nameEl.value = mobileEl.value = professionEl.value = fromEl.value = notesEl.value = "";
  ccEl.value = "+91";
};

async function processQueue(){
  if(!navigator.onLine || !syncQueue.length) return;
  updateStatus("Syncing changes…");
  const remaining = [];
  for(const job of syncQueue){
    if(job.op === "add"){
      const res = await apiPost({
        action:"add",
        name: job.payload.name,
        number: fullNumber(job.payload),
        profession: job.payload.profession,
        from: job.payload.from,
        notes: job.payload.notes
      });
      if(res.status!=="ok") remaining.push(job);
    }else if(job.op === "update"){
      const res = await apiPost({
        action:"update",
        originalMobile: job.original,
        name: job.payload.name,
        number: fullNumber(job.payload),
        profession: job.payload.profession,
        from: job.payload.from,
        notes: job.payload.notes
      });
      if(res.status!=="ok") remaining.push(job);
    }else if(job.op === "delete"){
      const res = await apiPost({
        action:"delete",
        originalMobile: job.original
      });
      if(!(res.status==="ok" || res.status==="not_found"))
        remaining.push(job);
    }
  }
  syncQueue = remaining;
  saveQueue();
  updateStatus(syncQueue.length ? "Some items could not sync" : "Synced to Google Sheet");
}

document.getElementById("searchBtn").onclick = ()=>search();

async function search(){
  const q = qEl.value.trim().toLowerCase();

  // 1) Local search
  const local = !q ? phonebook.slice() : phonebook.filter(item =>
    (item.name + " " + fullNumber(item) + " " +
     (item.profession||"") + " " + (item.from||"") + " " + (item.notes||""))
     .toLowerCase().includes(q)
  );
  render(local);
  if(!q){
    updateStatus("Showing local contacts ("+local.length+")");
  }else{
    updateStatus("Local results: "+local.length);
  }

  // 2) Online search (Google Sheet) – only if online
  if(!navigator.onLine) return;

  const res = await apiGet({action:"search", q});
  if(res && res.status==="ok" && Array.isArray(res.rows)){
    const remote = res.rows.map(r=>({
      name: r.Name || "",
      mobile: r.Number || "",
      profession: r.Profession || "",
      from: r.From || "",
      notes: r.Notes || "",
      countryCode: ""   // full number already in mobile
    }));

    // merge remote + local (no duplicate mobile / name)
    const merged = [...remote];
    local.forEach(lm=>{
      const lmKey = (fullNumber(lm) || lm.mobile).toLowerCase();
      if(!merged.some(rm => (rm.mobile||"").toLowerCase() === lmKey ||
                            (rm.name||"").toLowerCase() === (lm.name||"").toLowerCase())){
        merged.push(lm);
      }
    });
    render(merged);
    updateStatus("Remote results: "+remote.length+" | total shown: "+merged.length);
  }else{
    updateStatus("Online search failed — showing local only");
  }
}

window.onload = ()=>{
  initCountryList();
  render(phonebook);
  if(navigator.onLine) processQueue();
  updateStatus("Ready");
};
window.ononline = ()=>{ updateStatus("Back online — syncing…"); processQueue(); };
window.onoffline = ()=>{ updateStatus("Offline — local mode only"); };
</script>
</body>
</html>
